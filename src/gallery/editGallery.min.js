eg={GALLERY_ROOT:"../../public_html/images/gallery/",setup:function(){log.setup();$("#scan").click(eg.scan);$("#refresh").click(eg.refresh).click();$("#wrapper, #popup").click(eg.hide)}};
log={setup:function(){log.controls=[document.getElementById("scan"),document.getElementById("refresh")];log.status=document.getElementById("status");log.progress=document.getElementById("progress");log.clear()},info:function(a){log.status.innerHTML=a;log.status.className="";log.progress.style.display="none";log.setDisabled(!1)},error:function(a){log.status.innerHTML=a;log.status.className="error";log.progress.style.display="none";log.setDisabled(!1)},success:function(a){log.status.innerHTML=a;log.status.className=
"success";log.progress.style.display="none";log.setDisabled(!1)},clear:function(){log.status.innerHTML="";log.progress.style.display="none";log.setDisabled(!1)},wait:function(){log.status.innerHTML="";log.progress.style.display="";log.setDisabled(!0)},setDisabled:function(a){log.controls.forEach(function(e){e.disabled=a})}};eg.hideNew=function(){$(this).closest(".tile").find(".save").click()};
eg.refresh=function(){var a=$.post("editGallery.php","action=read");log.wait();a.done(function(a){var c;try{c=JSON.parse(a)}catch(d){console.error("failed to parse read response",d),log.error("failed to parse read response"),c={result:"json error",error:a},"Unexpected token <"===d.message&&(document.getElementById("images").innerHTML=a)}"success"==c.result?(log.success(c.data.length+" images"),eg.populateImages(c.data)):(console.error("read error",c.error),log.error("read error"))});a.fail(function(){console.error("refresh post error");
log.error("refresh post error")})};
eg.scan=function(){var a=$.post("editGallery.php","action=scan");log.wait();a.done(function(a){var c;try{c=JSON.parse(a)}catch(d){console.error("failed to parse scan response",d),log.error("failed to parse scan response"),c={result:"json error",error:a},"Unexpected token <"===d.message&&(document.getElementById("images").innerHTML=a)}"success"==c.result?log.success("added "+c.data.added+" - deleted "+c.data.deleted+" - cleaned "+c.data.cleaned):(console.error("scan error",c.error),log.error("scan error"))});
a.fail(function(){console.error("scan post error");log.error("scan post error")})};
eg.populateImages=function(a){var e=document.getElementById("images");util.removeChildren(e);a.forEach(function(c){var a=document.createElement("div");e.appendChild(a);a.className="col-md-2";var b=document.createElement("form");a.appendChild(b);b.originallyShown=""+c.show;a=document.createElement("div");b.appendChild(a);a.className="tile";c.isNew&&(a.className+=" new");b=document.createElement("div");a.appendChild(b);b.className="indicator";b.innerHTML="NEW";b.onclick=eg.hideNew;b=document.createElement("p");
a.appendChild(b);b.innerHTML=c.name;util.isOverflowed(b)&&(b.title=c.name);b=document.createElement("input");a.appendChild(b);b.type="hidden";b.name="name";b.value=c.name;b=document.createElement("div");a.appendChild(b);b.className="btn-group btn-group-sm";b.setAttribute("data-toggle","buttons");b.appendChild(eg.buildRadioButton("Show","true","btn-show",c.show));b.appendChild(eg.buildRadioButton("Hide","false","btn-hide",!c.show));b=document.createElement("img");a.appendChild(b);b.src=eg.GALLERY_ROOT+
c.name;b.name=c.name;b.className="img-thumbnail";b.onclick=eg.zoom;b=document.createElement("textarea");a.appendChild(b);b.rows=3;b.name="caption";b.value=c.caption;b.originalValue=null==c.caption?"":c.caption;b.onchange=eg.onChange;b.onkeyup=eg.onChange;c=document.createElement("button");a.appendChild(c);c.type="button";c.name="save";c.className="save btn btn-danger";c.style.display="none";c.innerHTML="Save";c.onclick=eg.save})};
eg.buildRadioButton=function(a,e,c,d){var b=document.createElement("label");b.className="btn "+c;b.onclick=eg.onChange;c=document.createElement("input");b.appendChild(c);c.type="radio";c.name="show";c.value=e;d&&(b.className+=" active",c.checked=!0);b.appendChild(document.createTextNode(a));return b};
eg.zoom=function(){var a=document.getElementById("wrapper"),e=document.getElementById("title"),c=document.getElementById("zoom"),d=document.getElementById("img"),b=document.getElementById("header"),h=document.getElementById("footer"),f=$(window),k=$(this).closest("form").get(0),l=f.height()-20,f=f.width()-20;d.src=this.src;d.style.maxHeight=l+"px";d.style.maxWidth=f+"px";a.style.visibility="hidden";var m=d.height;document.getElementById("popup").style.display="";var g=$(d).width(),d=$(d).height();
a.style.top=10+(l-d)/2+"px";a.style.left=10+(f-g)/2+"px";b.style.width=g+"px";h.style.width=g+"px";h.innerHTML=k.caption.value;c.innerHTML=(d/m*100).toFixed(0)+"%";e.innerHTML=k.name.value;a.style.visibility=""};eg.hide=function(){document.getElementById("popup").style.display="none"};
eg.onChange=function(){var a=this.form;setTimeout(function(){a.originallyShown!==a.show.value?a.save.style.display="":a.caption.originalValue.trim()!==a.caption.value.trim()?a.save.style.display="":a.save.style.display="none"},0)};
eg.save=function(){var a=this.form;a.caption.value=a.caption.value.trim();var e=$.post("editGallery.php",$(a).serialize()+"&action=save");e.done(function(c){var d;try{d=JSON.parse(c)}catch(b){console.error("failed to parse save response",b),log.error("failed to parse save response"),d={result:"json error",error:c},"Unexpected token <"===b.message&&(document.getElementById("images").innerHTML=c)}"success"==d.result?(a.save.style.display="none",$(a).find(".tile").removeClass("new"),log.success("saved")):
(console.error("save error",d.error),log.error("save error"))});e.fail(function(){console.error("save post error");log.error("save post error")})};$(document).ready(eg.setup);
